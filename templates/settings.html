{% extends "base.html" %}

{% block content %}
    <style>
        .card-header {
            background-color: rgba(var(--theme-primary-rgb, 255, 107, 0), 0.1);
        }
        .card-header-title {
            color: var(--theme-primary) !important;
        }
        .folder-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .folder-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
        }
        .folder-item:hover {
            background-color: var(--theme-primary-glow);
        }
        .folder-item .icon {
            margin-right: 0.5rem;
            color: var(--theme-primary);
        }
        .modal-card-head, .modal-card-foot {
            background-color: #2a2a2a;
        }
        .modal-card-body {
            background-color: #1a1a1a;
        }
        .modal-card-title {
            color: #fff;
        }
        /* Keep checkbox fields inside card content (avoid floating outside card) */
        .card-content .field .checkbox {
            padding-left: 45px;
        }
        .card-content .field .checkbox input[type="checkbox"] {
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        /* Collapsible sections */
        .card-header.is-collapsible {
            cursor: pointer;
            user-select: none;
        }

        .card-header .collapse-icon {
            margin-left: auto;
            margin-right: 1rem;
            transition: transform 0.3s ease;
            color: var(--theme-primary);
        }

        .card-header.is-collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .card-content.is-collapsible {
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            max-height: 2000px;
        }

        .card-content.is-collapsed {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        .config-status {
            font-size: 0.75rem;
            color: #48c78e;
            margin-left: 0.5rem;
            font-weight: normal;
        }

        /* Disabled input styling for auto-extract platforms */
        input.is-disabled {
            background-color: rgba(0, 0, 0, 0.3) !important;
            cursor: not-allowed;
            color: #888 !important;
        }
    </style>
    
    <script>
        let currentBrowsePath = '';
        let parentPath = null;
        let targetInputId = 'steamdeck_path';

        function openFolderBrowser() {
            targetInputId = 'steamdeck_path';
            const currentPath = document.getElementById('steamdeck_path').value || '~';
            document.getElementById('folder-modal').classList.add('is-active');
            loadFolders(currentPath);
        }

        function openBaseFolderBrowser() {
            targetInputId = 'base_path_input';
            const currentPath = document.getElementById('base_path_input').value || '~';
            document.getElementById('folder-modal').classList.add('is-active');
            loadFolders(currentPath);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleCard(header) {
            header.classList.toggle('is-collapsed');
            header.nextElementSibling.classList.toggle('is-collapsed');
        }

        // Per-platform install paths data (stored as JSON string in database)
        let platformInstallPaths = {};
        {% for platform in platform_matching %}
        (function() {
            let rawPaths = {{ platform.install_paths | default('[]') | tojson }};
            // Parse JSON string from database
            if (typeof rawPaths === 'string') {
                try {
                    platformInstallPaths[{{ platform.romm_platform_id }}] = JSON.parse(rawPaths);
                } catch (e) {
                    platformInstallPaths[{{ platform.romm_platform_id }}] = [];
                }
            } else if (Array.isArray(rawPaths)) {
                platformInstallPaths[{{ platform.romm_platform_id }}] = rawPaths;
            } else {
                platformInstallPaths[{{ platform.romm_platform_id }}] = [];
            }
        })();
        {% endfor %}

        function toggleInstallPaths(platformId, enabled) {
            const row = document.getElementById('install-paths-row-' + platformId);
            const platformRow = document.getElementById('platform-row-' + platformId);

            // Get ROM folder input and Save button
            const romFolderInput = platformRow?.querySelector('input[name="steamdeck_platform_name"]');
            const saveButton = platformRow?.querySelector('button[type="submit"]');

            if (row) {
                row.style.display = enabled ? '' : 'none';
                if (enabled) {
                    // Move ROM folder value to first install path if paths are empty
                    if (romFolderInput && romFolderInput.value.trim()) {
                        let paths = platformInstallPaths[platformId] || [];
                        if (paths.length === 0 || (paths.length === 1 && paths[0] === '')) {
                            platformInstallPaths[platformId] = [romFolderInput.value.trim()];
                        }
                        // Clear the ROM folder input
                        romFolderInput.value = '';
                    }
                    renderPlatformInstallPaths(platformId);
                }
            }

            // Disable/enable ROM folder input and Save button
            if (romFolderInput) {
                romFolderInput.disabled = enabled;
                romFolderInput.classList.toggle('is-disabled', enabled);
                if (enabled) {
                    romFolderInput.placeholder = 'Disabled - using install paths below';
                } else {
                    romFolderInput.placeholder = 'full-path';
                }
            }
            if (saveButton) {
                saveButton.disabled = enabled;
                saveButton.classList.toggle('is-hidden', enabled);
            }
        }

        function renderPlatformInstallPaths(platformId) {
            const container = document.getElementById('platform-install-paths-' + platformId);
            if (!container) return;

            let paths = platformInstallPaths[platformId] || [];
            if (paths.length === 0) paths = [''];

            container.innerHTML = paths.map((path, index) => `
                <div class="field has-addons mb-2">
                    <div class="control is-expanded">
                        <input class="input is-small" type="text"
                               id="platform-${platformId}-path-${index}"
                               placeholder="/home/deck/Games/PlatformName"
                               value="${escapeHtml(path)}">
                    </div>
                    <div class="control">
                        <button class="button is-info is-small" type="button" onclick="openPlatformInstallPathBrowser(${platformId}, ${index})">
                            <span class="icon"><i class="fa-solid fa-folder-open"></i></span>
                        </button>
                    </div>
                    ${paths.length > 1 ? `<div class="control">
                        <button class="button is-danger is-small" type="button" onclick="removePlatformInstallPath(${platformId}, ${index})" title="Remove">
                            <span class="icon"><i class="fa-solid fa-trash"></i></span>
                        </button>
                    </div>` : ''}
                </div>
            `).join('');
        }

        function syncPlatformInstallPaths(platformId) {
            const inputs = document.querySelectorAll(`[id^="platform-${platformId}-path-"]`);
            platformInstallPaths[platformId] = Array.from(inputs).map(el => el.value).filter(v => v.trim());
        }

        function addPlatformInstallPath(platformId) {
            syncPlatformInstallPaths(platformId);
            platformInstallPaths[platformId] = platformInstallPaths[platformId] || [];
            platformInstallPaths[platformId].push('');
            renderPlatformInstallPaths(platformId);
        }

        function removePlatformInstallPath(platformId, index) {
            syncPlatformInstallPaths(platformId);
            platformInstallPaths[platformId].splice(index, 1);
            if (platformInstallPaths[platformId].length === 0) platformInstallPaths[platformId] = [''];
            renderPlatformInstallPaths(platformId);
        }

        function openPlatformInstallPathBrowser(platformId, index) {
            targetInputId = `platform-${platformId}-path-${index}`;
            const input = document.getElementById(targetInputId);
            const currentPath = input ? input.value || '~' : '~';
            document.getElementById('folder-modal').classList.add('is-active');
            loadFolders(currentPath);
        }

        function savePlatformInstallPaths(platformId) {
            syncPlatformInstallPaths(platformId);
            const paths = platformInstallPaths[platformId] || [];

            // Also get the auto_extract checkbox state
            const platformRow = document.getElementById('platform-row-' + platformId);
            const autoExtractCheckbox = platformRow?.querySelector('input[name="auto_extract"]');
            const autoExtract = autoExtractCheckbox ? autoExtractCheckbox.checked : false;

            fetch(`/api/platform/${platformId}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ install_paths: paths, auto_extract: autoExtract })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Settings saved', 'success');
                } else {
                    showToast(data.error || 'Failed to save settings', 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving platform settings:', error);
                showToast('Failed to save settings', 'danger');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize platform install paths and disable inputs for platforms with auto_extract enabled
            {% for platform in platform_matching %}
            {% if platform.auto_extract %}
            (function() {
                const platformId = {{ platform.romm_platform_id }};
                const platformRow = document.getElementById('platform-row-' + platformId);
                const romFolderInput = platformRow?.querySelector('input[name="steamdeck_platform_name"]');
                const saveButton = platformRow?.querySelector('button[type="submit"]');

                if (romFolderInput) {
                    romFolderInput.disabled = true;
                    romFolderInput.classList.add('is-disabled');
                    romFolderInput.placeholder = 'Disabled - using install paths below';
                }
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.classList.add('is-hidden');
                }

                renderPlatformInstallPaths(platformId);
            })();
            {% endif %}
            {% endfor %}

            // Collapse configured sections on page load
            {% if config.get('romm_api_base_url', '') %}
            document.getElementById('api-header')?.classList.add('is-collapsed');
            document.getElementById('api-content')?.classList.add('is-collapsed');
            {% endif %}

            {% if config.get('default_platform_id', '') %}
            document.getElementById('platform-header')?.classList.add('is-collapsed');
            document.getElementById('platform-content')?.classList.add('is-collapsed');
            {% endif %}

            {% if config.get('download_staging_path', config.get('windows_download_path', '')) %}
            document.getElementById('staging-header')?.classList.add('is-collapsed');
            document.getElementById('staging-content')?.classList.add('is-collapsed');
            {% endif %}
        });

        function closeFolderBrowser() {
            document.getElementById('folder-modal').classList.remove('is-active');
        }

        function loadFolders(path) {
            fetch(`/api/browse_folders?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentBrowsePath = data.current_path;
                        parentPath = data.parent_path;
                        
                        document.getElementById('current-path-display').value = currentBrowsePath;
                        document.getElementById('parent-folder-btn').disabled = !parentPath;
                        
                        const folderList = document.getElementById('folder-list');
                        if (data.directories.length === 0) {
                            folderList.innerHTML = '<p class="has-text-grey">No subfolders</p>';
                        } else {
                            folderList.innerHTML = data.directories.map(dir => {
                                // Escape backslashes first, then single quotes for the onclick handler
                                const escapedPath = dir.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                                return `
                                <div class="folder-item" onclick="loadFolders('${escapedPath}')">
                                    <span class="icon"><i class="fa-solid fa-folder"></i></span>
                                    <span>${dir.name}</span>
                                </div>
                            `}).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading folders:', error);
                });
        }

        function navigateToParent() {
            if (parentPath) {
                loadFolders(parentPath);
            }
        }

        function selectCurrentFolder() {
            document.getElementById(targetInputId).value = currentBrowsePath;
            closeFolderBrowser();
        }
        
        function saveBasePath(btn) {
            const basePath = document.getElementById('base_path_input').value;

            fetch('/settings/base_path', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'base_path=' + encodeURIComponent(basePath)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    const originalText = btn.textContent;
                    btn.textContent = 'Saved!';
                    btn.classList.remove('is-primary');
                    btn.classList.add('is-success');
                    showToast('Base path saved', 'success');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('is-success');
                        btn.classList.add('is-primary');
                    }, 2000);
                } else {
                    showToast('Failed to save base path', 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving base path:', error);
                showToast('Failed to save base path', 'danger');
            });
        }
    </script>
    <section class="section">
        <div class="container">
            <h1 class="title">Settings</h1>

            <!-- RomM API Settings -->
            <div class="card has-background-dark mb-5">
                <header class="card-header is-collapsible" id="api-header" onclick="toggleCard(this)">
                    <p class="card-header-title">
                        RomM API Connection
                        {% if config.get('romm_api_base_url', '') %}<span class="config-status">Configured</span>{% endif %}
                    </p>
                    <span class="icon collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </header>
                <div class="card-content is-collapsible" id="api-content">
                    <form method="post" action="{{ url_for('settings_romm_api') }}">
                        <div class="field">
                            <label class="label">RomM API URL</label>
                            <div class="control">
                                <input class="input" type="text" placeholder="http://your-romm-server:8998/api" name="romm_api_base_url" value="{{ config.get('romm_api_base_url', '') }}">
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Username</label>
                            <div class="control">
                                <input class="input" type="text" placeholder="Username" name="romm_username" value="{{ config.get('romm_username', '') }}">
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Password</label>
                            <div class="control">
                                <input class="input" type="password" placeholder="Password" name="romm_password" value="{{ config.get('romm_password', '') }}">
                            </div>
                        </div>

                        <div class="control">
                            <button class="button is-primary" type="submit">
                                Save API Settings
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Default Platform -->
            <div class="card has-background-dark mb-5">
                <header class="card-header is-collapsible" id="platform-header" onclick="toggleCard(this)">
                    <p class="card-header-title">
                        Default Platform
                        {% if config.get('default_platform_id', '') %}<span class="config-status">Configured</span>{% endif %}
                    </p>
                    <span class="icon collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </header>
                <div class="card-content is-collapsible" id="platform-content">
                    <form method="post" action="{{ url_for('settings_default_platform') }}">
                        <div class="field">
                            <label class="label">Platform to load on startup</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="default_platform">
                                        {% for platform in platforms %}
                                        <option value="{{ platform.id }}" {% if config.get('default_platform_id', '249') == platform.id|string %}selected{% endif %}>
                                            {{ platform.name }} ({{ platform.rom_count }} games)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="control">
                            <button class="button is-primary" type="submit">
                                Save Default Platform
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Download Staging Path (for platforms with Auto-Extract) -->
            <div class="card has-background-dark mb-5">
                <header class="card-header is-collapsible" id="staging-header" onclick="toggleCard(this)">
                    <p class="card-header-title">
                        Download Staging Path
                        {% if config.get('download_staging_path', config.get('windows_download_path', '')) %}<span class="config-status">Configured</span>{% endif %}
                    </p>
                    <span class="icon collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </header>
                <div class="card-content is-collapsible" id="staging-content">
                    <p class="mb-4 has-text-grey-light">
                        For platforms with <strong>Auto-Extract</strong> enabled, compressed files (7z/zip) are first downloaded to this staging path, then extracted to the platform's install path.
                    </p>
                    <form method="post" action="{{ url_for('settings_staging_path') }}" id="staging-form">
                        <div class="field">
                            <label class="label">Staging Path</label>
                            <p class="help mb-2">Temporary location for downloaded archives before extraction</p>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input class="input" type="text" name="download_staging_path" id="steamdeck_path" placeholder="/home/deck/Downloads" value="{{ config.get('download_staging_path', config.get('windows_download_path', '')) }}">
                                </div>
                                <div class="control">
                                    <button class="button is-info" type="button" onclick="openFolderBrowser()">
                                        <span class="icon"><i class="fa-solid fa-folder-open"></i></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="control">
                            <button class="button is-primary" type="submit">
                                Save Staging Path
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Application Behavior -->
            <div class="card has-background-dark mb-5">
                <header class="card-header">
                    <p class="card-header-title">Application Behavior</p>
                </header>
                <div class="card-content">
                    <form method="post" action="{{ url_for('settings_browser') }}">
                        <div class="field">
                            <div class="control">
                                <label class="checkbox">
                                    <input type="checkbox" name="open_browser_on_startup" {% if config.get('open_browser_on_startup', '1') == '1' %}checked{% endif %}>
                                    Open RomM2SteamDeck in your browser automatically when the app starts
                                </label>
                            </div>
                            <p class="help mt-2 has-text-grey-light">
                                When disabled, you can manually open the app by navigating to <code>http://127.0.0.1:5001</code> in your browser.
                                Useful for kiosk setups or when launching the app through another launcher that manages the browser.
                            </p>
                        </div>
                        <div class="control">
                            <button class="button is-primary" type="submit">
                                Save Browser Setting
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Folder Browser Modal -->
            <div class="modal" id="folder-modal">
                <div class="modal-background" onclick="closeFolderBrowser()"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">Select Folder</p>
                        <button class="delete" aria-label="close" onclick="closeFolderBrowser()"></button>
                    </header>
                    <section class="modal-card-body" style="min-height: 400px;">
                        <div class="field">
                            <label class="label">Current Path</label>
                            <div class="control">
                                <input class="input" type="text" id="current-path-display" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button class="button is-small" id="parent-folder-btn" onclick="navigateToParent()">
                                <span class="icon"><i class="fa-solid fa-arrow-up"></i></span>
                                <span>Parent Folder</span>
                            </button>
                        </div>
                        <div id="folder-list" class="folder-list">
                            <!-- Folders will be listed here -->
                        </div>
                    </section>
                    <footer class="modal-card-foot">
                        <button class="button is-primary" onclick="selectCurrentFolder()">Select This Folder</button>
                        <button class="button" onclick="closeFolderBrowser()">Cancel</button>
                    </footer>
                </div>
            </div>

            <!-- Platform Folder Mapping -->
            <div class="card has-background-dark">
                <header class="card-header">
                    <p class="card-header-title">Platform Folder Mapping</p>
                </header>
                <div class="card-content">
                    <p class="mb-4 has-text-grey-light">
                        Map RomM platforms to local folder paths. Set a base path and click "Auto-Fill" to generate full paths using RomM's folder names.
                    </p>
                    
                    <div class="box has-background-grey-darker mb-4">
                        <div class="field">
                            <label class="label">Base Path for ROMs</label>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input class="input" type="text" name="base_path" id="base_path_input" placeholder="/home/deck/retrodeck/roms" value="{{ config.get('steamdeck_retrodeck_path', '') }}">
                                </div>
                                <div class="control">
                                    <button class="button is-info" type="button" onclick="openBaseFolderBrowser()">
                                        <span class="icon"><i class="fa-solid fa-folder-open"></i></span>
                                    </button>
                                </div>
                                <div class="control">
                                    <button class="button is-primary" type="button" onclick="saveBasePath(this)">
                                        Save
                                    </button>
                                </div>
                            </div>
                            <p class="help">Example: /home/deck/retrodeck/roms â†’ /home/deck/retrodeck/roms/3do</p>
                        </div>
                        <form method="post" action="{{ url_for('autofill_platform_folders') }}" id="autofill-form">
                            <input type="hidden" name="base_path" id="autofill_base_path">
                            <div class="buttons">
                                <button class="button is-warning" type="submit" onclick="document.getElementById('autofill_base_path').value = document.getElementById('base_path_input').value;">
                                    <span class="icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
                                    <span>Auto-Fill All Paths</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="mb-4">
                        <form method="post" action="{{ url_for('refresh_platforms') }}" style="display: inline;">
                            <button class="button is-info" type="submit">
                                <span class="icon"><i class="fa-solid fa-refresh"></i></span>
                                <span>Refresh Platforms from RomM</span>
                            </button>
                        </form>
                    </div>

                    <table class="table is-fullwidth">
                        <thead>
                            <tr>
                                <th>RomM Platform</th>
                                <th>RomM Folder</th>
                                <th>ROM Folder Path</th>
                                <th style="width: 100px;">Auto-Extract</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for platform in platform_matching %}
                            <tr id="platform-row-{{ platform.romm_platform_id }}">
                                <form method="post" action="{{ url_for('settings_platform_matching') }}" class="platform-form">
                                    <td class="is-vcentered">{{ platform.romm_platform_name }}</td>
                                    <td>
                                        <input class="input is-small" type="text" name="romm_fs_slug" placeholder="folder-slug" value="{{ platform.romm_fs_slug or '' }}" style="max-width: 120px;">
                                    </td>
                                    <td>
                                        <input type="hidden" name="romm_platform_id" value="{{ platform.romm_platform_id }}">
                                        <input class="input" type="text" name="steamdeck_platform_name" placeholder="full-path" value="{{ platform.steamdeck_platform_name }}">
                                    </td>
                                    <td class="has-text-centered">
                                        <label class="checkbox">
                                            <input type="checkbox" name="auto_extract" value="1" {% if platform.auto_extract %}checked{% endif %}
                                                   onchange="toggleInstallPaths({{ platform.romm_platform_id }}, this.checked)">
                                        </label>
                                    </td>
                                    <td>
                                        <button class="button is-primary is-small" type="submit">Save</button>
                                    </td>
                                </form>
                            </tr>
                            <!-- Install paths row (hidden by default, shown when auto_extract is enabled) -->
                            <tr id="install-paths-row-{{ platform.romm_platform_id }}" class="install-paths-row" style="{% if not platform.auto_extract %}display: none;{% endif %}">
                                <td colspan="5" style="background: rgba(0,0,0,0.2); padding: 1rem;">
                                    <div class="is-flex is-align-items-center mb-2">
                                        <span class="icon has-text-info mr-2"><i class="fa-solid fa-folder-tree"></i></span>
                                        <strong>Install Paths for {{ platform.romm_platform_name }}</strong>
                                    </div>
                                    <p class="help mb-3 has-text-grey-light">Where extracted files will be installed. Add multiple paths to choose destination during download.</p>
                                    <div id="platform-install-paths-{{ platform.romm_platform_id }}" class="platform-install-paths">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                    <button class="button is-info is-small mt-2" type="button" onclick="addPlatformInstallPath({{ platform.romm_platform_id }})">
                                        <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                        <span>Add Path</span>
                                    </button>
                                    <button class="button is-primary is-small mt-2 ml-2" type="button" onclick="savePlatformInstallPaths({{ platform.romm_platform_id }})">
                                        <span class="icon"><i class="fa-solid fa-save"></i></span>
                                        <span>Save Paths</span>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
{% endblock content %}
